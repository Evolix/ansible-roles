---
- block:
  - name: Copy Apache vhost
    template:
      src: apache.conf.j2
      dest: "/etc/apache2/sites-available/{{ nextcloud_instance_name }}.conf"
      mode: "0640"
    notify: reload apache
    tags:
      - nextcloud

  - name: Enable Apache vhost
    file:
      src: "/etc/apache2/sites-available/{{ nextcloud_instance_name }}.conf"
      dest: "/etc/apache2/sites-enabled/{{ nextcloud_instance_name }}.conf"
      state: link
    notify: reload apache
    tags:
      - nextcloud
  
  - name: Enable apache2 php configuration
    copy:
      src: "zzz-apache2-evolinux-custom.ini"
      dest: "/etc/php/7.4/apache2/conf.d/zzz-evolinux-custom.ini"
      mode: "0644"
      owner: root
      group: root
      force: yes
    notify: reload apache
    tags:
      - nextcloud
  
  - name: Enable cli php configuration
    copy:
      src: "zzz-cli-evolinux-custom.ini"
      dest: "/etc/php/7.4/cli/conf.d/zzz-evolinux-custom.ini"
      mode: "0644"
      owner: root
      group: root
      force: yes
    notify: reload apache
    tags:
      - nextcloud

  # - name: Generate ssl config
  #   shell:
  #     cmd: "/usr/local/sbin/vhost-domains {{ nextcloud_instance_name }} | /usr/local/sbin/make-csr {{ nextcloud_instance_name }}"
  #     creates: "/etc/nginx/ssl/{{ nextcloud_instance_name }}.conf"