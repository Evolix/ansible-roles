<VirtualHost *:80>
    ServerName {{ domains |first }}
    
    {% if not ssl.stat.exists %}
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteCond %{HTTP:X-Forwarded-Proto} !=https
    RewriteRule ^/(.*) https://%{SERVER_NAME}/$1 [L,R=permanent]
    {% endif %}

</VirtualHost>

{% if not ssl.stat.exists %}
<VirtualHost *:443>
    ServerName {{ domains |first }}

    DocumentRoot /home/{{ service }}/PrivateBin
    
    <Directory /home/{{ service }}/PrivateBin>
        Options SymLinksIfOwnerMatch
        AllowOverride Options=All AuthConfig Limit FileInfo Indexes
        Require all granted
    </Directory>
    
    AssignUserID {{ service }} {{ service }}

    SSLEngine On
    #SSLCertificateFile /etc/letsencrypt/live/{{ domains |first }}/fullchain.pem
    #SSLCertificateKeyFile /etc/letsencrypt/live/{{ domains |first }}/privkey.pem
    SSLCertificateFile /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
    
    RewriteEngine On
    RewriteCond %{HTTPS} !=on
    RewriteCond %{HTTP:X-Forwarded-Proto} !=https
    RewriteRule ^/(.*) https://%{SERVER_NAME}/$1 [L,R=permanent]

</VirtualHost>
{% endif %}
