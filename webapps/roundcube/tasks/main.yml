---
- name: configure roundcube-core
  debconf:
    name: roundcube-core
    question: "{{ item.key }}"
    value: "{{ item.value }}"
    vtype: "{{ item.type }}"
  with_items:
  - { key: 'roundcube/dbconfig-reinstall', type: 'boolean', value: 'true' }
  - { key: 'roundcube/language', type: 'select', value: 'fr_FR' }
  - { key: 'roundcube/remote/port', type: 'string', value: '1143' }
  - { key: 'roundcube/hosts', type: 'string', value: '127.0.0.1' }
  - { key: 'roundcube/database-type', type: 'select', value: 'sqlite3' }
  - { key: 'roundcube/db/basepath', type: 'string', value: '/var/lib/roundcube/' }
  tags:
  - roundcube

- name: install Roundcube
  apt:
    name: "{{ item }}"
    state: present
  with_items:
  - roundcube
  - roundcube-sqlite3
  - roundcube-plugins
  - php-net-sieve
  tags:
  - roundcube

- name: configure managesieve plugin
  copy:
    src: /usr/share/roundcube/plugins/managesieve/config.inc.php.dist
    dest: /etc/roundcube/plugins/managesieve/config.inc.php
    mode: "0644"
    remote_src: True
  tags:
  - roundcube

- name: enable default plugins
  replace:
    dest: /etc/roundcube/config.inc.php
    regexp: "^\\$config\\['plugins'\\] = array\\($"
    replace: "$config['plugins'] = array('zipdownload','managesieve'"
  tags:
  - roundcube

- name: deploy roundcube vhost
  template:
    src: apache2.conf.j2
    dest: /etc/apache2/sites-available/rouncube.conf
    mode: "0640"
  notify: reload apache2
  tags:
  - roundcube

- name: enable roundcube vhost
  file:
    src: /etc/apache2/sites-available/rouncube.conf
    dest: /etc/apache2/sites-enabled/rouncube.conf
    state: link
  notify: reload apache2
  tags:
  - roundcube
