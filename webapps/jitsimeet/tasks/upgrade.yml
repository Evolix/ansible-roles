---
# tasks file for jitsimeet upgrade

- name: "Stop running services via docker-compose"
  docker_compose:
    project_src: "/var/opt/{{ unix_user }}/docker-jitsi-meet-{{ version_old }}"
    state: absent
  become_user: "{{ unix_user }}"

- name: "Download and uncompress new Docker Compose project for Jitsi Meet"
  unarchive: 
    src: "https://github.com/jitsi/docker-jitsi-meet/archive/refs/tags/{{ version }}.tar.gz"
    dest: "/var/opt/{{ unix_user }}"
    remote_src: yes
  become_user: "{{ unix_user }}"

- name: "Template .env for Jitsi Meet's Docker Compose project"
  template:
    src: "env.j2"
    dest: "/var/opt/{{ unix_user }}/docker-jitsi-meet-{{ version }}/.env"
    owner: "{{ unix_user }}"
    group: "{{ unix_user }}"
    mode: '644'

- name: "(Re)generate strong passwords using dev provided script"
  command: ./gen-passwords.sh
  args:
    chdir: "/var/opt/{{ unix_user }}/docker-jitsi-meet-{{ version }}/"
  become_user: "{{ unix_user }}"
  
- name: "Start services via docker-compose"
  docker_compose:
    project_src: "/var/opt/{{ unix_user }}/docker-jitsi-meet-{{ version }}"
    state: present
  become_user: "{{ unix_user }}"
