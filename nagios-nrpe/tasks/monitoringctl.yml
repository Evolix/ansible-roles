---
### Dependencies

- name: "Install dependencies"
  ansible.builtin.apt:
    name:
      - python3-distro
    state: present

- name: "Remount /usr if needed"
  ansible.builtin.include_role:
    name: remount-usr

### Get upstream

- name: "Generate random string for /tmp dir"
  ansible.builtin.set_fact:
    tmp_path: /tmp/monitoringctl_{{ lookup('community.general.random_string', length=12, special=false) }}

- name: Create tmp dir
  delegate_to: localhost
  become: false
  ansible.builtin.file:
    path: "{{ tmp_path }}"
    state: directory
  changed_when: false

- name: "Download monitoringctl files from Gitea to localhost in /tmp"
  delegate_to: localhost
  become: false
  ansible.builtin.get_url:
    url: "https://gitea.evolix.org/evolix/monitoringctl/raw/branch/{{ monitoringctl_branch }}/{{ item }}"
    dest: "{{ tmp_path }}/{{ item }}"
  loop:
    - alerts_wrapper.py
    - check-local
    - check-local_completion
    - monitoringctl
    - monitoringctl_common
    - monitoringctl_common.py
    - monitoringctl_completion
  changed_when: false

### alerts_wrapper and alerts_switch section

- name: "dir /usr/local/lib/monitoringctl/ exists"
  ansible.builtin.file:
    path: /usr/local/lib/monitoringctl/
    state: directory
    mode: "0755"

- name: "alerts_switch is removed"
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "/usr/share/scripts/alerts_switch"
    - "/usr/local/bin/alerts_switch"

- name: "nagios user can run monitoringctl enable with sudo (used by alerts_wrapper)"
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/monitoringctl
    regexp: "nagios.*alerts_switch"
    line: "nagios           ALL = NOPASSWD:/usr/local/bin/monitoringctl enable *"
    create: true
    owner: root
    group: root
    mode: "0640"
    validate: "visudo -c -f %s"

- name: "Remove nagios sudoer for old alerts_switch"
  ansible.builtin.lineinfile:
    path: /etc/sudoers.d/monitoringctl
    regexp: "nagios.*alerts_switch"
    state: "absent"
    validate: "visudo -c -f %s"

- name: "Old alerts_wrapper are removed"
  ansible.builtin.file:
    path: "{{ nagios_plugins_directory }}/alerts_wrapper"
    state: "absent"

- name: "Copy alerts_wrapper"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/alerts_wrapper.py"
    dest: "{{ monitoringctl_wrapper_path }}"
    owner: root
    group: staff
    mode: "0755"
    force: true

- name: "Copy monitoringctl_common lib"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/monitoringctl_common"
    dest: /usr/local/lib/monitoringctl/common
    owner: root
    group: root
    mode: "0644"
    force: true

- name: "Copy monitoringctl_common.py lib (for alerts_wrapper.py)"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/monitoringctl_common.py"
    dest: /usr/local/lib/monitoringctl/common.py
    owner: root
    group: root
    mode: "0644"
    force: true


### monitoringctl section

- name: "Package bash-completion is installed"
  ansible.builtin.apt:
    name: bash-completion

- name: "Package nagios-nrpe-plugin is installed"
  ansible.builtin.apt:
    name: nagios-nrpe-plugin

- name: "Remount /usr RW after apt hook put it RO"
  ansible.builtin.include_role:
    name: remount-usr

- name: "Directory /etc/bash_completion.d exists"
  ansible.builtin.file:
    path: /etc/bash_completion.d
    state: directory
    mode: "0755"

- name: "Directory /var/lib/monitoringctl/ exists"
  ansible.builtin.file:
    path: /var/lib/monitoringctl/
    state: directory
    mode: "0755"

- name: "monitoringctl is not in /usr/local/sbin/"
  ansible.builtin.file:
    path: /usr/local/sbin/monitoringctl
    state: absent

- name: "Copy monitoringctl"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/monitoringctl"
    dest: /usr/local/bin/monitoringctl
    owner: root
    group: root
    mode: "0755"
    force: true

- name: "Copy monitoringctl_common lib"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/monitoringctl_common"
    dest: /usr/local/lib/monitoringctl/common
    owner: root
    group: root
    mode: "0644"
    force: true

- name: "Copy monitoringctl_completion script"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/monitoringctl_completion"
    dest: /etc/bash_completion.d/monitoringctl
    owner: root
    group: root
    mode: "0644"
    force: true

- name: "Copy check-local (it's just a wrapper calling 'monitoringctl check' for backward compatibility)"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/check-local"
    dest: /usr/local/bin/check-local
    owner: root
    group: root
    mode: "0755"
    force: true

- name: "Copy completion for check-local"
  ansible.builtin.copy:
    src: "{{ tmp_path }}/check-local_completion"
    dest: /etc/bash_completion.d/check-local
    mode: "0755"

- name: "Remove tmp dir on localhost"
  delegate_to: localhost
  become: false
  ansible.builtin.file:
    path: "{{ tmp_path }}"
    state: absent
  changed_when: false

