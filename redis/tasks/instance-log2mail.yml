---

- name: log2mail config is present
  blockinfile:
    dest: /etc/log2mail/config/redis.conf
    owner: log2mail
    group: adm
    mode: "0640"
    create: yes
    marker: "# {mark} ANSIBLE MANAGED RULES FOR INSTANCE {{ redis_instance_name }}"
    content: |
      file = {{ redis_log_dir }}/redis-server.log
      pattern = "Cannot allocate memory"
      mailto = {{ log2mail_alert_email or general_alert_email | mandatory }}
      template = /etc/log2mail/mail
  notify: restart log2mail
  when: log2mail_config_dir.stat.exists
  tags:
    - redis
    - log2mail
