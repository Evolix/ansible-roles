---
- name: bundle update
  bundler:
    state: present
    gemfile: "/home/{{ redmine_user }}/www/Gemfile"
    gem_path: "/home/{{ redmine_user }}/.gems"
    user_install: yes
  become_user: "{{ redmine_user }}"

- name: rake migrate
  shell: bundle exec rake -qf ~/www/Rakefile db:migrate
  become_user: "{{ redmine_user }}"
  become_method: sudo
  become_flags: '-iu {{ redmine_user }}'

- name: puma reload
  systemd:
    name: puma
    daemon_reload: yes
    state: reloaded
    user: yes
  become_user: "{{ redmine_user }}"
  become_method: sudo
  become_flags: '-iu {{ redmine_user }}'
