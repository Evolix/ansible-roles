---

- name: "create logical volumes for {{ kvm-guest__name }} on kvm cloud"
  block:
    - name: "create logical volumes on {{ kvm-guest__primary }}"
      lvol:
        vg: "{{ item.group }}"'
        lv: "{{ item.name }}"
        size: "{{ item.size }}"
      with_items: "{{ kvm-guest__volumes }}"
      delegate_to: "{{ kvm-guest__primary }}"
      register: kvm-guest_primary_lvm

    - name: 'create logical volumes on {{ kvm-guest__secondary }}"'
      lvol:
        vg: "{{ item.group }}"'
        lv: "{{ item.name }}"
        size: "{{ item.size }}"
      with_items: "{{ kvm-guest__volumes }}"
      delegate_to: "{{ kvm-guest__secondary }}"
      when: kvm-guest_primary_lvm

- name: "create DRBD ressources for {{ kvm-guest__name }} on kvm cloud"
  block:
    - name: "create DRBD ressource on {{ kvm-guest__primary }}"
      template:
        src: 'drbd_vm.res.j2'
        dest: "/etc/drbd.d/{{ kvm-guest__name }}.res"
      delegate_to: "{{ kvm-guest__primary }}"
      register: kvm-guest_primary_lvm

    - name: 'create DRBD ressource on {{ kvm-guest__secondary }}"'
      template:
        src: 'drbd_vm.res.j2'
        dest: "/etc/drbd.d/{{ kvm-guest__name }}.res"
      delegate_to: "{{ kvm-guest__secondary }}"
      when: kvm-guest_primary_lvm
