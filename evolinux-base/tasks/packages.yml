---

- name: Install/Update system tools
  apt:
    name: "{{ item }}"
  with_items:
  - locales
  - sudo
  - ntpdate
  - lsb-release
  - dnsutils
  - pv
  - apg
  - conntrack
  - logrotate
  - bash-completion
  - ssl-cert
  - ca-certificates
  - rename
  when: evolinux_packages_system

- name: Install/Update diagnostic tools
  apt:
    name: "{{ item }}"
  with_items:
  - strace
  - htop
  - iftop
  - iptraf
  - ncdu
  - iotop
  - tcpdump
  - mtr-tiny
  - curl
  - telnet
  - traceroute
  - man
  when: evolinux_packages_diagnostic

- name: Install/Update hardware tools
  apt:
    name: "{{ item }}"
  with_items:
  - hdparm
  - smartmontools
  - lm-sensors
  when: evolinux_packages_hardware

- name: Install/Update common tools
  apt:
    name: "{{ item }}"
  with_items:
  - vim
  - screen
  - tmux
  - mutt
  - tree
  - git
  - subversion
  - rsync
  - bc
  - pinentry-curses
  - ncurses-term
  when: evolinux_packages_common

- name: Be sure that openntpd package is absent/purged
  apt:
    name: openntpd
    state: absent
    purge: yes
  when: evolinux_packages_purge_openntpd

- name: Be sure locate/mlocate is absent/purged
  apt:
    name: "{{ item }}"
    state: absent
    purge: yes
  with_items:
  - locate
  - mlocate
  when: evolinux_packages_purge_locate

- name: Install/Update serveur-base meta-package
  apt:
    name: serveur-base
    allow_unauthenticated: yes
  when: evolinux_packages_serveur_base

- name: Install/Update packages for Stretch and later
  apt:
    name: "{{ item }}"
  with_items:
  - net-tools
  - spectre-meltdown-checker
  when:
  - evolinux_packages_stretch
  - ansible_distribution_major_version | version_compare('9', '>=')

- name: Customize logcheck recipient
  lineinfile:
    dest: /etc/logcheck/logcheck.conf
    regexp: '^SENDMAILTO=".*"$'
    line: 'SENDMAILTO="{{ logcheck_alert_email or general_alert_email | mandatory }}"'
  when: evolinux_packages_logcheck_recipient

- name: Deleting rpcbind and nfs-common
  apt:
    name: "{{ item }}"
    state: absent
  with_items:
    - rpcbind
    - nfs-common
  when: evolinux_packages_delete_nfs


# TODO: use ini_file when Ansible > 2.1 (no_extra_spaces: yes)

- name: Configure Listchanges on Jessie
  lineinfile:
    dest: /etc/apt/listchanges.conf
    regexp: '^{{ item.option }}\s*='
    line: "{{ item.option }}={{ item.value }}"
  with_items:
    - { option: "confirm", value: "1" }
    - { option: "which",   value: "both" }
  when:
    - evolinux_packages_listchanges
    - ansible_distribution == "Debian"
    - ansible_distribution_release == "jessie"

- name: apt-listchanges is absent on Stretch and later
  apt:
    name: apt-listchanges
    state: absent
  when:
    - ansible_distribution == "Debian"
    - ansible_distribution_major_version | version_compare('9', '>=')

- meta: flush_handlers
