---

- name: "System compatibility checks"
  assert:
    that:
      - ansible_distribution == "Debian"
      - ansible_distribution_major_version is version('8', '>=')
    msg: only compatible with Debian >= 8

- name: Apt configuration
  include_role:
    name: evolix/apt
  vars:
    apt_install_basics: "{{ evolinux_apt_replace_default_sources }}"
    apt_install_evolix_public: "{{ evolinux_apt_public_sources }}"
  when: evolinux_apt_include | bool

- name: /etc versioning with Git
  include_role:
    name: evolix/etc-git
  when: evolinux_etcgit_include | bool

- name: /etc/evolinux base
  include: etc-evolinux.yml
  when: evolinux_etcevolinux_include | bool

- name: Hostname
  include: hostname.yml
  when: evolinux_hostname_include | bool

- name: Kernel tuning
  include: kernel.yml
  when: evolinux_kernel_include | bool

- name: Fstab configuration
  include: fstab.yml
  when: evolinux_fstab_include | bool

- name: Packages
  include: packages.yml
  when: evolinux_packages_include | bool

- name: System settings
  include: system.yml
  when: evolinux_system_include | bool

- name: Minifirewall
  include_role:
    name: evolix/minifirewall
  when: evolinux_minifirewall_include | bool

- name: Evomaintenance
  include_role:
    name: evolix/evomaintenance
  when: evolinux_evomaintenance_include | bool

- name: SSH configuration
  include: ssh.yml
  when: evolinux_ssh_include | bool

### disabled because of a memory leak
# - name: Create evolinux users
#   include_role:
#     name: evolix/evolinux-users
#   when: evolinux_users_include

- name: Root user configuration
  include: root.yml
  when: evolinux_root_include | bool

- name: Postfix
  include: postfix.yml
  when: evolinux_postfix_include | bool

- name: Logs management
  include: logs.yml
  when: evolinux_logs_include | bool

- name: Default index page
  include: default_www.yml
  when: evolinux_default_www_include | bool

- name: Hardware drivers and tools
  include: hardware.yml
  when: evolinux_hardware_include | bool

- name: Customize for Online.net
  include: provider_online.yml
  when: evolinux_provider_online_include | bool

- name: Customize for Orange FCE
  include: provider_orange_fce.yml
  when: evolinux_provider_orange_fce_include | bool

- name: Override Log2mail service
  include: log2mail.yml
  when: evolinux_log2mail_include | bool

- include: motd.yml

- name: Munin
  include_role:
    name: evolix/munin
  when: evolinux_munin_include | bool

- name: Nagios/NRPE
  include_role:
    name: evolix/nagios-nrpe
  when: evolinux_nagios_nrpe_include | bool

- name: fail2ban
  include_role:
    name: evolix/fail2ban
  when: evolinux_fail2ban_include | bool

- name: Evocheck
  include_role:
    name: evolix/evocheck
  vars:
    evocheck_force_install: "{{ evolinux_evocheck_force_install }}"
  when: evolinux_evocheck_include | bool

- name: Listupgrade
  include_role:
    name: evolix/listupgrade
  when: evolinux_listupgrade_include | bool

- name: Generate ldif script
  include_role:
    name: evolix/generate-ldif
  when: evolinux_generateldif_include | bool
