---
- ansible.builtin.set_fact:
    domains_script_name: evodomains
    domains_config_path: /etc/evolinux/domains
    domains_ignored_domains_list: ignored_domains_check.list
    domains_included_domains_list: included_domains_check.list
    domains_allowed_ips_list: allowed_ips_check.list
    domains_dependencies: []
#      - python3-cryptography
#      - socat
    domains_allowed_ips:
       - 127.0.0.1
       - 31.170.13.1  # boost05
       - 31.170.8.100  # boost04
       - 54.39.237.40  # cariboost
       - 31.170.11.208  # boost-mrs00
       - 31.170.13.9  # boost-par00
       - 31.170.11.118  # boost-pp00


- name: Ensure dependencies are installed
  ansible.builtin.apt:
    name: '{{ item }}'
  loop: '{{ domains_dependencies }}'

- name: Copy {{ domains_script_name }} script to local sbin
  ansible.builtin.copy:
    src: '{{ domains_script_name }}.py'
    dest: '/usr/local/sbin/{{ domains_script_name }}'
    mode: '0700'

- name: Create config file {{ domains_ignored_domains_list }}
  ansible.builtin.blockinfile:
    path: '{{ domains_config_path }}/{{ domains_ignored_domains_list }}'
    create: true
    marker: '### {mark} ANSIBLE MANAGED HEADER'
    insertbefore: BOF
    block: |
      # Domains present in vhosts or SSL certificates whose DNS records should
      # not be checked by 'evodomains --check-dns'.
      # Note: custom record IPs can also be added to /etc/evolinux/evodomains_allowed_ips.list,
      # this is useful for load-balanced domains or NAT.
      # Format: one domain per line, regex and wildcards not supported.

- name: Create config file {{ domains_included_domains_list }}
  ansible.builtin.blockinfile:
    path: '{{ domains_config_path }}/{{ domains_included_domains_list }}'
    create: true
    marker: '### {mark} ANSIBLE MANAGED HEADER'
    insertbefore: BOF
    block: |
      # Domains absent from vhosts or SSL certificates whose DNS records must
      # be checked by 'evodomains --check-dns'.
      # Format: one domain per line, regex and wildcards not supported.

- name: Create config file {{ domains_allowed_ips_list }}
  ansible.builtin.blockinfile:
    path: '{{ domains_config_path }}/{{ domains_allowed_ips_list }}'
    create: true
    marker: '### {mark} ANSIBLE MANAGED HEADER'
    insertbefore: BOF
    block: |
      # External IPs the domains of this server are allowed to point for
      # 'evodomains --check-dns'.
      # This is useful for load-balanced domains or NAT.
      # Note: the network interfaces IPs of the server are allowed by default.
      # Format: one IP per line, regex and wildcards not supported.

- name: Add default allowed IPs in config file
  ansible.builtin.lineinfile:
    path: '{{ domains_config_path }}/{{ domains_allowed_ips_list }}'
    line: '{{ item }}'
  loop: '{{ domains_allowed_ips }}'

