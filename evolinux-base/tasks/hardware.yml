---
- name: Install pciutils
  apt:
    name: pciutils
    state: present

## Broadcom NetXtreme II

- name: Check if Broadcom NetXtreme II device is present
  shell: "lspci | grep -q 'NetXtreme II'"
  check_mode: no
  register: broadcom_netextreme_search
  failed_when: False
  changed_when: False

# TODO: add the "non-free" part to the existing sources
# instead of adding a new source

- name: Add non-free repo for Broadcom NetXtreme II
  include_role:
    name: evolix/apt
    tasks_from: basics.yml
  vars:
    apt_basics_components: "main contrib non-free"
  when: broadcom_netextreme_search.rc == 0

## RAID

- name: Detect if RAID is installed
  shell: lspci | grep "RAID bus controller" | grep -v Intel
  check_mode: no
  register: raidmodel
  changed_when: "'FAILED' in raidmodel.stdout"
  failed_when: "'FAILED' in raidmodel.stdout"

- name: HP Smart Array package is present
  block:
    - name: Add HPE GPG key
      apt_key:
        #url: https://downloads.linux.hpe.com/SDR/hpePublicKey2048_key1.pub
        data: "{{ lookup('file', 'hpePublicKey2048_key1.pub') }}"

    - name: Add HPE repository
      apt_repository:
        repo: 'deb https://downloads.linux.hpe.com/SDR/repo/mcp {{ ansible_distribution_release }}/current non-free'
        state: present

    - name: Install packages for HP hardware
      apt:
        name:
          - cciss-vol-status
          - ssacli
        state: present

    - name: Configure packages for HP hardware
      template:
        src: hardware/cciss-vol-statusd.j2
        dest: /etc/init.d/cciss-vol-statusd
        mode: "0755"

    - name: Enable HP hardware in systemd
      service:
        name: cciss-vol-statusd
        enabled: true
        state: started
  when: "'Hewlett-Packard Company Smart Array' in raidmodel.stdout"

- name: MegaRAID SAS package is present
  block:
    - name: Add HW tool GPG key
      apt_key:
        # url: https://hwraid.le-vert.net/debian/hwraid.le-vert.net.gpg.key
        data: "{{ lookup('file', 'hwraid.le-vert.net.gpg.key') }}"
      when: ansible_distribution_major_version is version_compare('9', '>=')

    - name: Add HW tool repository
      apt_repository:
        repo: 'deb http://hwraid.le-vert.net/debian {{ ansible_distribution_release }} main'
        state: present

    - name: Install packages for DELL/LSI hardware
      apt:
        name:
          - megacli
          - megaclisas-status
        allow_unauthenticated: yes

    - name: Configure packages for DELL/LSI hardware
      template:
        src: hardware/megaclisas-statusd.j2
        dest: /etc/default/megaclisas-statusd
        mode: "0755"

    - name: Enable DELL/LSI hardware in systemd
      service:
        name: megaclisas-statusd
        enabled: true
        state: started
  when: "'MegaRAID SAS' in raidmodel.stdout"

- meta: flush_handlers
