---

- name: APT https transport is enabled
  apt:
    name: apt-transport-https
    state: present
  tags:
    - metricbeat
    - packages

- name: Elastic embedded GPG key is absent
  apt_key:
    id: "D88E42B4"
    keyring: /etc/apt/trusted.gpg
    state: absent
  tags:
    - metricbeat
    - packages

- name: Elastic GPG key is installed
  copy:
    src: elastic.asc
    dest: /etc/apt/trusted.gpg.d/elastic.asc
    force: yes
    mode: "0644"
    owner: root
    group: root
  tags:
    - metricbeat
    - packages

- name: Elastic sources list is available
  apt_repository:
    repo: "deb https://artifacts.elastic.co/packages/{{ elastic_stack_version | mandatory }}/apt stable main"
    filename: elastic
    state: present
    update_cache: yes
  tags:
    - metricbeat
    - packages

- name: Metricbeat is installed
  apt:
    name: metricbeat
    state: "{% if metribeat_upgrade_package %}latest{% else %}present{% endif %}"
  notify: restart metricbeat
  tags:
    - metricbeat
    - packages

- name: Metricbeat service is enabled
  systemd:
    name: metricbeat
    enabled: yes
  notify: restart metricbeat

# When we don't use a config template (default)
- block:
  - name: Metricbeat knows where to find Elasticsearch
    lineinfile:
      dest: /etc/metricbeat/metricbeat.yml
      regexp: '^  hosts: .*'
      line: "  hosts: [\"{{ metricbeat_elasticsearch_hosts | join('\", \"') }}\"]"
      insertafter: "output.elasticsearch:"
    notify: restart metricbeat
    when: metricbeat_elasticsearch_hosts | length > 0

  - name: Metricbeat protocol for Elasticsearch
    lineinfile:
      dest: /etc/metricbeat/metricbeat.yml
      regexp: '^  #?protocol: .*'
      line: "  protocol: \"{{ metricbeat_elasticsearch_protocol }}\""
      insertafter: "output.elasticsearch:"
    notify: restart metricbeat
    when: metricbeat_elasticsearch_protocol == "http" or metricbeat_elasticsearch_protocol == "https"

  - name: Metricbeat auth/username for Elasticsearch are configured
    lineinfile:
      dest: /etc/metricbeat/metricbeat.yml
      regexp: '{{ item.regexp }}'
      line: '{{ item.line }}'
      insertafter: "output.elasticsearch:"
    loop:
      - { regexp: '^  #?username: .*', line: '  username: "{{ metricbeat_elasticsearch_auth_username }}"' }
      - { regexp: '^  #?password: .*', line: '  password: "{{ metricbeat_elasticsearch_auth_password }}"' }
    notify: restart metricbeat
    when:
      - metricbeat_elasticsearch_auth_username | length > 0
      - metricbeat_elasticsearch_auth_password | length > 0

  - name: Metricbeat api_key for Elasticsearch are configured
    lineinfile:
      dest: /etc/metricbeat/metricbeat.yml
      regexp: '^  #?api_key: .*'
      line: '  api_key: "{{ metricbeat_elasticsearch_auth_api_key }}"'
      insertafter: "output.elasticsearch:"
    notify: restart metricbeat
    when: metricbeat_elasticsearch_auth_api_key | length > 0

  - name: disable cloud_metadata
    replace:
      dest: /etc/metricbeat/metricbeat.yml
      regexp: '^(\s+)(- add_cloud_metadata:)'
      replace: '\1# \2'
    notify: restart metricbeat
    when: not (metricbeat_processors_cloud_metadata | bool)

  - name: cloud_metadata processor is disabled
    lineinfile:
      dest: /etc/metricbeat/metricbeat.yml
      line: "  - add_cloud_metadata: ~"
      insert_after: '^processors:'
    notify: restart metricbeat
    when: metricbeat_processors_cloud_metadata | bool
  when: not (metricbeat_use_config_template | bool)

# When we use a config template
- block:
  - name: Configuration is up-to-date
    template:
      src: "{{ item }}"
      dest: /etc/metricbeat/metricbeat.yml
      force: "{{ metricbeat_force_config }}"
    loop: "{{ query('first_found', templates) }}"
    vars:
      templates:
        - "templates/metricbeat/metricbeat.{{ inventory_hostname }}.yml.j2"
        - "templates/metricbeat/metricbeat.{{ host_group | default('all') }}.yml.j2"
        - "templates/metricbeat/metricbeat.default.yml.j2"
        - "templates/metricbeat.default.yml.j2"
      notify: restart metricbeat
      when: metricbeat_update_config | bool
  when: metricbeat_use_config_template | bool
