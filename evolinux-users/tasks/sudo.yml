---
- name: "Verify 'evolinux' sudoers file presence for debian jessie"
  template:
    src: "sudoers_jessie.j2"
    dest: /etc/sudoers.d/evolinux
    force: no
    mode: "0440"
    validate: '/usr/sbin/visudo -cf %s'
  register: copy_sudoers_evolinux
  when: ansible_distribution_release == "jessie"

- name: "Verify 'evolinux' sudoers file presence for debian 9 or bigger"
  template:
    src: "sudoers_stretch.j2"
    dest: /etc/sudoers.d/evolinux
    force: no
    mode: "0440"
    validate: '/usr/sbin/visudo -cf %s'
  register: copy_sudoers_evolinux
  when: ansible_distribution_major_version | version_compare('9', '>=')

- name: "Add user in sudoers file for '{{ item.name }}' (jessie)"
  replace:
    dest: /etc/sudoers.d/evolinux
    regexp: '^(User_Alias\s+ADMINS\s+=((?!{{ item.name }}).)*)$'
    replace: '\1,{{ item.name }}'
    validate: '/usr/sbin/visudo -cf %s'
  with_dict: "{{ evolinux_users }}"
  when:
    - not copy_sudoers_evolinux.changed
    - ansible_distribution_release == "jessie"

- name: "Create '{{ evolinux_sudo_group }}' group (Debian 9 or later)"
  group:
    name: "{{ evolinux_sudo_group }}"
    system: yes
  when: ansible_distribution_major_version | version_compare('9', '>=')

- include: sudo_stretch.yml
  vars:
    user: "{{ item.value }}"
  with_dict: "{{ evolinux_users }}"
  when: ansible_distribution_major_version | version_compare('9', '>=')

- meta: flush_handlers
