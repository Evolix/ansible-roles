---

- name: search profile for presence of evomaintenance
  command: 'grep -q "trap.*sudo.*evomaintenance.sh"'
  changed_when: False
  failed_when: False
  check_mode: no
  register: grep_profile_evomaintenance

# Don't add the trap if it is present or commented
- name: "Add evomaintenance trap for '{{ user.name }}'"
  lineinfile:
    state: present
    dest: '/home/{{ user.name }}/.profile'
    insertafter: EOF
    line: 'trap "sudo /usr/share/scripts/evomaintenance.sh" 0'
  when: grep_profile_evomaintenance.rc != 0
