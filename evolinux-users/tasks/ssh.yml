---
- name: "Fix perms on ssh directory"
  file:
    name: "/home/{{ item }}/.ssh"
    state: directory
    owner: "{{ item }}"
    group: "{{ item }}"
    mode: "0700"
  with_items: "{{ evolinux_users | list }}"

- name: "Add user's SSH public key"
  authorized_key:
    user: "{{ item.key }}"
    key: "{{ item.value.ssh_key }}"
    state: present
  when: item.value.ssh_key is defined
  with_dict: "{{ evolinux_users }}"

# we must double-escape caracters, because python
- name: verify AllowUsers directive
  shell: "grep -E '^AllowUsers' /etc/ssh/sshd_config"
  changed_when: False
  failed_when: False
  register: grep_allowusers_ssh
  check_mode: no

- name: "Add AllowUsers sshd directive"
  lineinfile:
    dest: /etc/ssh/sshd_config
    line: "\nAllowUsers {{ evolinux_users | list | join(' ') }}"
    insertafter: 'Subsystem'
    validate: '/usr/sbin/sshd -T -f %s'
  notify: reload sshd
  when: grep_allowusers_ssh.rc != 0

- name: "Update AllowUsers sshd directive"
  replace:
    dest: /etc/ssh/sshd_config
    regexp: '^(AllowUsers ((?!\b{{ item }}\b).)*)$'
    replace: '\1 {{ item }}'
    validate: '/usr/sbin/sshd -T -f %s'
  notify: reload sshd
  with_items: "{{ evolinux_users | list }}"
  when: grep_allowusers_ssh.rc == 0

- name: "verify Match User directive"
  command: "grep 'Match User' /etc/ssh/sshd_config"
  changed_when: False
  failed_when: False
  register: grep_matchuser_ssh
  check_mode: no

- name: "Add Match User sshd directive (Jessie)"
  lineinfile:
    dest: /etc/ssh/sshd_config
    line: "\nMatch User {{ evolinux_users | list | join(',') }}\n    PasswordAuthentication no"
    insertafter: "# END EVOLINUX PASSWORD RESTRICTIONS BY ADDRESS"
    validate: '/usr/sbin/sshd -T -f %s'
  notify: reload sshd
  when:
    - ansible_distribution_release == "jessie"
    - grep_matchuser_ssh.rc != 0

- name: "Update Match User's sshd directive (Jessie)"
  replace:
    dest: /etc/ssh/sshd_config
    regexp: '^(Match User ((?!{{ item }}).)*)$'
    replace: '\1,{{ item }}'
    validate: '/usr/sbin/sshd -T -f %s'
  notify: reload sshd
  with_items: "{{ evolinux_users | list }}"
  when:
    - ansible_distribution_release == "jessie"
    - grep_matchuser_ssh.rc == 0
