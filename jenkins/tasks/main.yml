---

## TODO: add those URLs or domains to the proxy whitelist
# http://pkg.jenkins-ci.org/.*
# http://mirrors.jenkins.io/.*
# http://jenkins.mirror.isppower.de/.*

- name: Look for legacy apt keyring
  stat:
    path: /etc/apt/trusted.gpg
  register: _trusted_gpg_keyring

- name: Jenkins embedded GPG key is absent
  apt_key:
    id: "D50582E6"
    keyring: /etc/apt/trusted.gpg
    state: absent
  when: _trusted_gpg_keyring.stat.exists

- name: Add Jenkins GPG key
  copy:
    src: jenkins.asc
    dest: "{{ apt_keyring_dir }}/jenkins.asc"
    force: yes
    mode: "0644"
    owner: root
    group: root

- name: Add jenkins APT repository
  apt_repository:
    repo: deb [signed-by={{ apt_keyring_dir }}/jenkins.asc] http://pkg.jenkins-ci.org/debian-stable binary/
    filename: jenkins
    update_cache: yes

- name: Remove unsigned jenkins APT repository
  apt_repository:
    repo: deb http://pkg.jenkins-ci.org/debian-stable binary/
    filename: jenkins
    update_cache: yes
    state: absent

- name: Install Jenkins
  apt:
    name: jenkins

- name: Change Jenkins port
  replace:
    name: /etc/default/jenkins
    regexp: "^HTTP_PORT=.*$"
    replace: "HTTP_PORT=8081"
  notify: Restart Jenkins
